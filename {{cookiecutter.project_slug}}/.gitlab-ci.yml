{% if cookiecutter.include_cdk == 'yes' %}stages:
  - test
  - security
  - build
  - deploy

variables:
  PYTHON_VERSION: "{{cookiecutter.python_version}}"
  AWS_DEFAULT_REGION: "{{cookiecutter.aws_region}}"
  SERVICE_NAME: "{{cookiecutter.project_slug}}"
  IMAGE_TAG: ${CI_COMMIT_SHORT_SHA}
  ECR_REGISTRY: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Cache for pip dependencies
cache:
  paths:
    - .pip-cache/
    - .venv/

# Test stage
test:unit:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - apt-get update && apt-get install -y git
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache --upgrade pip
    - pip install --cache-dir .pip-cache -e ".[dev]"
  script:
    - ruff check .
    - ruff format --check .
    - mypy src/{{cookiecutter.package_name}}
    - pytest --cov=src --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Security scanning
security:secrets:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --cache-dir .pip-cache detect-secrets
  script:
    - detect-secrets scan --all-files --baseline .secrets.baseline
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build Docker image
build:image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - REPO_URI=$ECR_REGISTRY/$SERVICE_NAME:$IMAGE_TAG
    - docker build -t $REPO_URI .
    - docker push $REPO_URI
    - echo "IMAGE_URI=$REPO_URI" > build.env
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^(develop|staging)$/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

# Deploy infrastructure
deploy:infrastructure:
  stage: deploy
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - apt-get update && apt-get install -y nodejs npm git
    - npm install -g aws-cdk
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache -e ".[cdk]"
  script:
    - cd infrastructure
    - cdk bootstrap --require-approval never
    - cdk deploy --all --require-approval never
  environment:
    name: ${CI_COMMIT_REF_SLUG}
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        ENVIRONMENT: "prod"
    - if: $CI_COMMIT_BRANCH == "develop"
      variables:
        ENVIRONMENT: "dev"
    - if: $CI_COMMIT_BRANCH == "staging"
      variables:
        ENVIRONMENT: "staging"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      variables:
        ENVIRONMENT: "feature"

# Cleanup feature branch deployments
cleanup:feature-branch:
  stage: deploy
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - apt-get update && apt-get install -y nodejs npm git
    - npm install -g aws-cdk
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache -e ".[cdk]"
  script:
    - cd infrastructure
    - cdk destroy --all --force
  when: manual
  environment:
    name: ${CI_COMMIT_REF_SLUG}
    action: stop
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

# Production deployment approval
deploy:production:
  stage: deploy
  extends: deploy:infrastructure
  environment:
    name: production
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    ENVIRONMENT: "prod"

{% else %}stages:
  - test
  - security
  - build
  - deploy

variables:
  PYTHON_VERSION: "{{cookiecutter.python_version}}"

# Cache for pip dependencies
cache:
  paths:
    - .pip-cache/
    - .venv/

# Test stage
test:unit:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache --upgrade pip
    - pip install --cache-dir .pip-cache -e ".[dev]"
  script:
    - ruff check .
    - ruff format --check .
    - mypy src/{{cookiecutter.package_name}}
    - pytest --cov=src --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Security scanning
security:secrets:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --cache-dir .pip-cache detect-secrets
  script:
    - detect-secrets scan --all-files --baseline .secrets.baseline
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build package
build:package:
  stage: build
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache --upgrade pip build twine
  script:
    - python -m build
    - twine check dist/*
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Deploy to PyPI (manual for releases)
deploy:pypi:
  stage: deploy
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --cache-dir .pip-cache twine
  script:
    - twine upload dist/* --username __token__ --password $PYPI_TOKEN
  dependencies:
    - build:package
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
  environment:
    name: pypi
    url: https://pypi.org/project/{{cookiecutter.project_slug}}/

# Deploy documentation (if applicable)
deploy:docs:
  stage: deploy
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache -e ".[dev]"
    - pip install --cache-dir .pip-cache mkdocs mkdocs-material
  script:
    - mkdocs build
    - mkdir public
    - cp -r site/* public/
  artifacts:
    paths:
      - public
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  environment:
    name: documentation
    url: https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}

{% endif %}# Common jobs for both CDK and non-CDK projects

# Dependency vulnerability scanning
security:dependencies:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache --upgrade pip
    - pip install --cache-dir .pip-cache safety
  script:
    - safety check --json --output safety-report.json || true
    - safety check
  artifacts:
    reports:
      dependency_scanning: safety-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Code quality analysis
test:quality:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --cache-dir .pip-cache --upgrade pip
    - pip install --cache-dir .pip-cache -e ".[dev]" radon xenon
  script:
    - radon cc src/ --min B
    - radon mi src/ --min B
    - xenon src/ --max-absolute B --max-modules B --max-average A
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH